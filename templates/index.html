<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Oblique Strategies Online</title>
</head>
<body>
<div style="text-align:center;">
    <h1>Oblique Strategies</h1>

    <div id="apiKeySection">
        <h3>Enter your API key</h3>
        <p>This script uses the truly random quantum number generator from ANU.<br/>
            In order to use it, go to <a href="https://quantumnumbers.anu.edu.au/" target="_blank">their website</a> and sign up for a free account.
            <br/>Then, go to 'API keys', copy your key and paste it below.
        </p>
        <input type="text" name="apikey" id="apikey" size="50"><br/><br/>
        <button id="saveApiKeyButton">Save API Key</button>

    </div>

    <h3>Enter your question</h3>
    <input type="text" name="question" id="question" size="50" disabled><br/><br/>
    <button id="submitbutton" disabled>Ask</button>

    <h4 id="interfacetext"></h4>
    <h2 id="answer"></h2>

</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var apiKeyInput = document.getElementById('apikey');
        var saveApiKeyButton = document.getElementById('saveApiKeyButton');

        // Initially disable the save button
        saveApiKeyButton.disabled = true;

        // Event listener for API key input
        apiKeyInput.addEventListener('keyup', function() {
            var apiKeyLength = apiKeyInput.value.length;
            saveApiKeyButton.disabled = apiKeyLength !== 40;
        });

        // Check if API key is stored in cookies
        var apiKey = getCookie('apiKey');
        if (apiKey) {
            document.getElementById('question').disabled = false;
            document.getElementById('submitbutton').disabled = false;
            document.getElementById('apiKeySection').style.display = 'none';
        }
    });
    document.getElementById('saveApiKeyButton').addEventListener('click', function() {
        var apiKey = document.getElementById('apikey').value;
        if (apiKey) {
            setCookie('apiKey', apiKey, 30); // Save for 30 days
            document.getElementById('question').disabled = false;
            document.getElementById('submitbutton').disabled = false;
            document.getElementById('apiKeySection').style.display = 'none';
        }
    });


    document.getElementById('submitbutton').addEventListener('click', function() {
        // Get the user's question
        var question = document.getElementById('question').value;
        var interfacetext = document.getElementById('interfacetext');
        var answer = document.getElementById('answer');

        if (!question) {
            interfacetext.innerText = 'Please enter a question.';
            return;
        }

        // Clear previous answer and interface text
        interfacetext.innerText = '';
        answer.innerText = '';

        // Simulate the thinking process
        interfacetext.innerText = "Mentalize your intention...";

        var count = 1;
        var interval = setInterval(function() {
            if (count <= 20) {
                interfacetext.innerText = "Mentalize your intention... " + count;
                count++;
            } else {
                clearInterval(interval);
                interfacetext.innerText = "ok";

                setTimeout(function() {
                    interfacetext.innerText = "Sending API request"
                    var apiKey = getCookie('apiKey');
                    setTimeout(function(){
                        fetch('/get-strategy',{
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ apiKey: apiKey })
                        })
                        .then(response => response.json())
                        .then(data => {
                            interfacetext.innerText = "Result:"
                            setTimeout(function() {answer.innerText = data.strategy;}, 1000);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            answer.innerText = "Error fetching strategy";
                        });
                    },1000);
                }, 1000);
            }
        }, 1000);
    });
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }

    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
</script>

</body>
</html>